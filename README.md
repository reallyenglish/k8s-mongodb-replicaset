## Runing mongodb replica set using kubernetes statefulset

It uses 2 init containers to setup a mongodb replica set:
- First init container uses [k8s-init-container](https://github.com/reallyenglish/k8s-init-container) docker image to copy [lookup-srv](https://github.com/ochko/lookup-srv) binary to shared `/work-dir` volume.
- Second init container uses [mongo](https://hub.docker.com/_/mongo/) image, and initializes replica set
- Main container runs mongodb server on already initialized replica set at `/data/db` dir.

### Prerequisites

- Kubernetes 1.6(`initContainers` is out or beta)
- Persistent Volumes(to persist mongodb data)

### Installing

Create a namespace and apply yaml files:
```console
$ kubectl create ns demo
$ kubectl apply -f . --namespace demo
```

You should see logs(not in container logs but in stackdriver logs):
```
# first pod initializes a replica set
Starting mongod on mongo-0 ...
Waiting for mongod is up ...
Mongod is up. Probing peers in mongo-rs ...
Initializing replica set for mongo-0.mongo-rs.demo.svc.cluster.local ...
Stopping mongod on mongo-0 ...
# second pod is added to the replica set
Starting mongod on mongo-1 ...
Waiting for mongod is up ...
Mongod is up. Probing peers in mongo-rs ...
Adding myself to the replica set at mongo-0.mongo-rs.demo.svc.cluster.local ...
Stopping mongod on mongo-1 ...
# third pod is added to the replica set
Starting mongod on mongo-2 ...
Waiting for mongod is up ...
Mongod is up. Probing peers in mongo-rs ...
Adding myself to the replica set at mongo-0.mongo-rs.demo.svc.cluster.local ...
Stopping mongod on mongo-2 ...
```

Now simulate master down:
```console
$ kubectl exec -ti mongo-0 -- /usr/bin/mongo admin --eval 'db.shutdownServer({force: true})'
```

In logs for mongo-2 you should find mongo-0 is changing role to secondary, and mongo-1 or mongo-2 becomes new master.

```
...
REPL     [ReplicationExecutor] Member mongo-0.mongo-rs.demo.svc.cluster.local:27017 is now in state SECONDARY
...
REPL     [ReplicationExecutor] Member mongo-1.mongo-rs.demo.svc.cluster.local:27017 is now in state PRIMARY
```
